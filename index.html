<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bridge ‚Äì MPS Research & Oversight</title>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#ffffff;--bg-card:#f8f9fb;--bg-hover:#f1f3f7;--bg-surface:#f3f4f6;--border:#e2e5ea;--border-a:#cbd0d8;--text:#1a1f2e;--text-s:#4b5563;--text-m:#6b7280;--accent:#2563eb;--accent-h:#1d4ed8;--accent-g:rgba(37,99,235,.08);--green:#059669;--green-bg:rgba(5,150,105,.08);--red:#dc2626;--red-bg:rgba(220,38,38,.08);--amber:#d97706;--amber-bg:rgba(217,119,6,.08);--purple:#7c3aed;--sw:240px;--r:10px;--rs:6px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sw);background:#0d1424;border-right:1px solid #1e293b;position:fixed;top:0;left:0;bottom:0;z-index:100;display:flex;flex-direction:column}
.sidebar-header{padding:24px 20px;border-bottom:1px solid #1e293b}
.logo{font-family:'DM Sans',sans-serif;font-size:22px;font-weight:700;letter-spacing:-.5px;display:flex;align-items:center;gap:10px;color:#e2e8f0}
.logo-mark{width:28px;height:24px;flex-shrink:0}
.sidebar-nav{flex:1;padding:12px 10px}
.nav-sl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:#64748b;padding:8px 12px 6px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--rs);color:#94a3b8;cursor:pointer;font-size:13.5px;transition:all .15s;user-select:none}
.nav-item:hover{background:#111827;color:#e2e8f0}
.nav-item.active{background:rgba(59,130,246,.15);color:#3b82f6;font-weight:500}
.nav-icon{width:18px;height:18px;opacity:.7;flex-shrink:0}
.nav-item.active .nav-icon{opacity:1}
.sidebar-footer{padding:16px 20px;border-top:1px solid #1e293b;font-size:11px;color:#64748b}
.main{margin-left:var(--sw);flex:1;min-height:100vh}
.topbar{position:sticky;top:0;z-index:50;background:var(--bg);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 32px;height:56px;display:flex;align-items:center;justify-content:space-between}
.topbar-title{font-size:14px;font-weight:500}
.content{padding:28px 32px;max-width:1400px}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;transition:border-color .2s}
.card:hover{border-color:var(--accent)}
.card-h{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-t{font-size:14px;font-weight:600}
.card-b{padding:22px}
.grid{display:grid;gap:20px}
.g2{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(4,1fr)}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);padding:20px}
.stat-l{font-size:11.5px;font-weight:500;text-transform:uppercase;letter-spacing:.8px;color:var(--text-m);margin-bottom:8px}
.stat-v{font-family:'DM Sans',sans-serif;font-size:28px;font-weight:700;letter-spacing:-1px}
.stat-c{font-size:12px;margin-top:4px;font-weight:500}
.stat-c.pos{color:var(--green)}.stat-c.neg{color:var(--red)}
.btn{padding:8px 16px;border-radius:var(--rs);font-size:13px;font-weight:500;font-family:inherit;border:none;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-p{background:var(--accent);color:#fff}.btn-p:hover{background:var(--accent-h)}
.btn-g{background:transparent;color:var(--text-s);border:1px solid var(--border)}.btn-g:hover{background:var(--bg-card);color:var(--text)}
.btn-sm{padding:5px 10px;font-size:12px}
.badge{display:inline-flex;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:.3px}
.b-blue{background:var(--accent-g);color:var(--accent)}.b-green{background:var(--green-bg);color:var(--green)}.b-amber{background:var(--amber-bg);color:var(--amber)}.b-red{background:var(--red-bg);color:var(--red)}.b-purple{background:rgba(139,92,246,.12);color:var(--purple)}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 14px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-m);border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:12px 14px;border-bottom:1px solid var(--border);color:var(--text-s);white-space:nowrap}
tr:hover td{background:rgba(0,0,0,.02)}tr:last-child td{border-bottom:none}
td.nc{color:var(--text);font-weight:500}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;align-items:flex-end}
.fg{display:flex;flex-direction:column;gap:4px}
.fl{font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-m)}
select,input[type=text],input[type=number]{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--rs);padding:7px 12px;font-size:13px;color:var(--text);font-family:inherit;outline:none;min-width:140px;transition:border-color .15s}
select:focus,input:focus{border-color:var(--accent)}select{cursor:pointer}
.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:24px;flex-wrap:wrap}
.tab{padding:10px 18px;font-size:13px;font-weight:500;color:var(--text-m);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;user-select:none;white-space:nowrap}
.tab:hover{color:var(--text-s)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.insight-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);padding:22px;cursor:pointer;transition:all .2s}
.insight-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.im{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:12px;color:var(--text-m)}
.it{font-size:16px;font-weight:600;margin-bottom:8px;line-height:1.4}
.is{font-size:13.5px;color:var(--text-s);line-height:1.6}
.ph{background:linear-gradient(135deg,rgba(37,99,235,.06),rgba(99,102,241,.04));border:1px solid var(--border);border-radius:var(--r);padding:32px;margin-bottom:24px}
.pn{font-family:'DM Sans',sans-serif;font-size:28px;font-weight:700;margin-bottom:4px}
.pm{display:flex;gap:24px;flex-wrap:wrap}
.pmi{display:flex;flex-direction:column;gap:2px}
.pml{font-size:10.5px;color:var(--text-m);text-transform:uppercase;letter-spacing:.8px}
.pmv{font-size:15px;font-weight:600}
.slist,.clist{list-style:none;padding:0}
.slist li,.clist li{padding:8px 0;padding-left:20px;position:relative;font-size:13.5px;color:var(--text-s);line-height:1.5}
.slist li::before{content:"‚úì";position:absolute;left:0;color:var(--green);font-weight:700}
.clist li::before{content:"‚Äì";position:absolute;left:0;color:var(--amber);font-weight:700}
.article{font-size:14.5px;line-height:1.8;color:var(--text-s);max-width:720px}
.article p{margin-bottom:16px}.article strong{color:var(--text);font-weight:600}
.article h3{color:var(--text);font-size:16px;margin:20px 0 8px}
.article ul{margin:0 0 16px 20px}.article li{margin-bottom:4px}
.cc{position:relative;width:100%}
.back{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--text-m);cursor:pointer;margin-bottom:20px;transition:color .15s}.back:hover{color:var(--accent)}
.ab{display:flex;height:8px;border-radius:4px;overflow:hidden;margin:8px 0}
.al-eq{background:var(--accent)}.al-bo{background:var(--green)}.al-al{background:var(--purple)}.al-ca{background:var(--text-m)}
.al{display:flex;gap:16px;margin-top:6px;font-size:11.5px;color:var(--text-m)}.al span{display:flex;align-items:center;gap:4px}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.ph1{margin-bottom:24px}.ph1 h1{font-family:'DM Sans',sans-serif;font-size:24px;font-weight:700;letter-spacing:-.5px;margin-bottom:4px}.ph1 p{color:var(--text-s);font-size:14px}
.loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-m);font-size:13px}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.cr{cursor:pointer}.cr:hover td{color:var(--text)}
.fi{animation:fi .3s ease-out}@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.bv-inline{background:linear-gradient(135deg,rgba(37,99,235,.04),rgba(99,102,241,.03));border:1px solid rgba(37,99,235,.15);border-radius:var(--r);padding:20px 22px;margin-bottom:20px}
.bv-inline-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:13px;font-weight:600;color:var(--accent)}
.bv-inline-content{font-size:13.5px;color:var(--text-s);line-height:1.7}
.bv-inline-content p{margin-bottom:10px}.bv-inline-content strong{color:var(--text);font-weight:600}
.bv-inline-content p:last-child{margin-bottom:0}
.cd-editable{padding:18px;min-height:80px;font-size:13.5px;line-height:1.7;color:var(--text-s);outline:none;font-family:inherit}
.cd-editable:focus{background:rgba(59,130,246,.03)}
.cd-editable:empty::before{content:attr(data-placeholder);color:var(--text-m)}
.ms-wrap{position:relative;display:inline-block;min-width:160px}
.ms-btn{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--rs);padding:7px 28px 7px 12px;font-size:13px;color:var(--text);cursor:pointer;width:100%;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:inherit;transition:border-color .15s;appearance:none}
.ms-btn:focus{border-color:var(--accent);outline:none}
.ms-btn::after{content:'‚ñæ';position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text-m);font-size:11px;pointer-events:none}
.ms-dd{display:none;position:absolute;top:100%;left:0;min-width:100%;max-height:220px;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);box-shadow:0 4px 12px rgba(0,0,0,.08);z-index:60;margin-top:2px}
.ms-dd.open{display:block}
.ms-opt{display:flex;align-items:center;gap:8px;padding:7px 12px;font-size:12.5px;color:var(--text-s);cursor:pointer;transition:background .1s}
.ms-opt:hover{background:var(--bg-hover)}
.ms-opt input{accent-color:var(--accent);margin:0}
@media(max-width:1024px){.g4{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.sidebar{transform:translateX(-100%)}.main{margin-left:0}.g2,.g3,.g4{grid-template-columns:1fr}.content{padding:20px 16px}.tabs{overflow-x:auto}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#cbd0d8;border-radius:3px}
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;align-items:center;justify-content:center}
.login-box{width:380px;padding:40px;text-align:center}
.login-box .logo{justify-content:center;font-size:28px;margin-bottom:8px;color:var(--text)}
.login-box .logo .logo-mark{width:34px;height:28px}
.login-sub{color:var(--text-m);font-size:14px;margin-bottom:32px}
.login-field{width:100%;margin-bottom:14px;padding:10px 14px;border:1px solid var(--border);border-radius:var(--rs);font-size:14px;font-family:inherit;color:var(--text);background:var(--bg-card);outline:none;transition:border-color .15s}
.login-field:focus{border-color:var(--accent)}
.login-btn{width:100%;padding:11px;background:var(--accent);color:#fff;border:none;border-radius:var(--rs);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .15s}
.login-btn:hover{background:var(--accent-h)}
.login-err{color:var(--red);font-size:12.5px;margin-top:10px;min-height:18px}
.login-hint{color:var(--text-m);font-size:11.5px;margin-top:20px;line-height:1.5}
.user-pill{display:flex;align-items:center;gap:8px;padding:5px 10px;border-radius:20px;background:var(--bg-card);border:1px solid var(--border);font-size:12px;color:var(--text-s);cursor:pointer;transition:all .15s}
.user-pill:hover{border-color:var(--accent);color:var(--text)}
.user-avatar{width:24px;height:24px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600}
.msg-form{display:flex;flex-direction:column;gap:12px}
.msg-form input,.msg-form textarea{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--rs);padding:9px 12px;font-size:13px;color:var(--text);font-family:inherit;outline:none;transition:border-color .15s;width:100%}
.msg-form input:focus,.msg-form textarea:focus{border-color:var(--accent)}
.msg-form textarea{resize:vertical;min-height:80px}
.sub-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;border:1px solid var(--border);font-family:inherit}
.sub-btn.subscribed{background:var(--green-bg);color:var(--green);border-color:var(--green)}
.sub-btn.unsubscribed{background:var(--bg-card);color:var(--text-s)}
.sub-btn:hover{border-color:var(--accent)}
.toggle{position:relative;display:inline-block;width:44px;height:24px;cursor:pointer;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle .track{position:absolute;inset:0;background:var(--border);border-radius:12px;transition:background .2s}
.toggle input:checked+.track{background:var(--accent)}
.toggle .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.15)}
.toggle input:checked~.knob{left:22px}
.toggle-sm{width:36px;height:20px}
.toggle-sm .knob{width:16px;height:16px}
.toggle-sm input:checked~.knob{left:18px}
.toggle-green input:checked+.track{background:var(--green)}
.msg-item{padding:14px 18px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
.msg-item:hover{background:var(--bg-hover)}
.msg-item:last-child{border-bottom:none}
</style>
</head>
<body>
<div class="login-overlay" id="loginOverlay">
<div class="login-box">
<div class="logo"><img src="bridge-logo-nav.png" alt="Bridge" style="height:32px;width:auto"></div>
<div class="login-sub">Independent MPS Research & Oversight</div>
<input class="login-field" type="email" id="loginEmail" placeholder="Email address" autocomplete="email">
<input class="login-field" type="password" id="loginPass" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
<button class="login-btn" onclick="doLogin()">Sign In</button>
<div class="login-err" id="loginErr"></div>
</div>
</div>
<div class="app" id="appShell" style="display:none">
<aside class="sidebar">
<div class="sidebar-header"><div class="logo"><img src="bridge-logo-dark.png" alt="Bridge" style="height:30px;width:auto"></div></div>
<nav class="sidebar-nav">
<div class="nav-sl">Overview</div>
<div class="nav-item active" data-page="dashboard" onclick="nav('dashboard')">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
Homepage</div>
<div class="nav-sl" style="margin-top:8px">Research</div>
<div class="nav-item" data-page="analysis" onclick="nav('analysis')">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
MPS Analysis</div>
<div class="nav-item" data-page="selection" onclick="nav('selection')">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
MPS Selection</div>
<div class="nav-item" data-page="insights" onclick="nav('insights')">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/></svg>
Insights</div>
<div class="nav-sl" style="margin-top:8px">Account</div>
<div class="nav-item" data-page="messages" onclick="nav('messages')">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
Messages</div>
<div class="nav-item" data-page="account" onclick="nav('account')">
<svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
Preferences</div>
</nav>
<div class="sidebar-footer">Bridge v1.0 ¬∑ Independent MPS Research</div>
</aside>
<main class="main">
<div class="topbar">
<div class="topbar-title" id="tt">Homepage</div>
<div style="display:flex;gap:8px;align-items:center">
<button class="btn btn-g btn-sm" onclick="nav('selection')">‚åï Search MPS</button>
<div class="user-pill" id="userPill" onclick="toggleUserMenu()">
<div class="user-avatar" id="userAvatar"></div>
<span id="userName"></span>
<span style="font-size:10px;color:var(--text-m)">‚ñæ</span>
</div>
</div>
</div>
<div class="content" id="app"><div class="loading"><div class="spinner"></div>Loading...</div></div>
</main>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const $=id=>document.getElementById(id);let S={p:'dashboard',c:{},pr:{},bvOpen:true,user:null},CH={};

// ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAuth(){
try{const r=await fetch('/api/auth/me');const d=await r.json();
if(d.authenticated){S.user=d.user;showApp();return true}}catch(e){}
showLogin();return false}

function showLogin(){$('loginOverlay').style.display='flex';$('appShell').style.display='none';$('loginEmail').value='';$('loginPass').value='';$('loginErr').textContent=''}
function showApp(){$('loginOverlay').style.display='none';$('appShell').style.display='flex';
$('userAvatar').textContent=S.user.name.split(' ').map(w=>w[0]).join('');
$('userName').textContent=S.user.name;
// Load and apply preferences
fetch('/api/preferences').then(r=>r.json()).then(d=>{if(d.preferences?.display?.dark_mode)savePrefApplyDark(true)}).catch(()=>{});
render()}

async function doLogin(){
const email=$('loginEmail').value.trim(),pass=$('loginPass').value;
$('loginErr').textContent='';
if(!email||!pass){$('loginErr').textContent='Please enter email and password';return}
try{const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pass})});
if(r.ok){const d=await r.json();S.user=d.user;showApp()}
else{const d=await r.json();$('loginErr').textContent=d.detail||'Login failed'}}
catch(e){$('loginErr').textContent='Connection error'}}

async function doLogout(){
try{await fetch('/api/auth/logout',{method:'POST'})}catch(e){}
S.user=null;S.c={};showLogin()}

function toggleUserMenu(){
const existing=document.getElementById('userMenu');
if(existing){existing.remove();return}
const pill=$('userPill');const rect=pill.getBoundingClientRect();
const menu=document.createElement('div');menu.id='userMenu';
menu.style.cssText=`position:fixed;top:${rect.bottom+4}px;right:${window.innerWidth-rect.right}px;background:var(--bg);border:1px solid var(--border);border-radius:var(--rs);box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:200;min-width:180px;overflow:hidden`;
menu.innerHTML=`<div style="padding:12px 16px;border-bottom:1px solid var(--border)"><div style="font-size:13px;font-weight:600">${S.user.name}</div><div style="font-size:11px;color:var(--text-m)">${S.user.firm}</div></div>
<div style="padding:4px"><div style="padding:8px 12px;font-size:13px;cursor:pointer;border-radius:4px;color:var(--text-s)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('userMenu').remove();nav('account')">Preferences</div>
<div style="padding:8px 12px;font-size:13px;cursor:pointer;border-radius:4px;color:var(--text-s)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('userMenu').remove();nav('messages')">Messages</div>
<div style="padding:8px 12px;font-size:13px;cursor:pointer;border-radius:4px;color:var(--red)" onmouseover="this.style.background='var(--red-bg)'" onmouseout="this.style.background=''" onclick="document.getElementById('userMenu').remove();doLogout()">Sign Out</div></div>`;
document.body.appendChild(menu);
setTimeout(()=>{const close=e=>{if(!menu.contains(e.target)&&!pill.contains(e.target)){menu.remove();document.removeEventListener('click',close)}};document.addEventListener('click',close)},0)}

function savePrefApplyDark(dark){
const root=document.documentElement;
const loginLogo=document.querySelector('.login-box .logo img');
if(dark){root.style.setProperty('--bg','#0f1117');root.style.setProperty('--bg-card','#1a1d2e');root.style.setProperty('--bg-hover','#242736');root.style.setProperty('--bg-surface','#1a1d2e');root.style.setProperty('--border','#2a2d3e');root.style.setProperty('--border-a','#3a3d4e');root.style.setProperty('--text','#e2e8f0');root.style.setProperty('--text-s','#94a3b8');root.style.setProperty('--text-m','#64748b');if(loginLogo)loginLogo.src='bridge-logo-dark.png'}
else{root.style.setProperty('--bg','#ffffff');root.style.setProperty('--bg-card','#f8f9fb');root.style.setProperty('--bg-hover','#f1f3f7');root.style.setProperty('--bg-surface','#f3f4f6');root.style.setProperty('--border','#e2e5ea');root.style.setProperty('--border-a','#cbd0d8');root.style.setProperty('--text','#1a1f2e');root.style.setProperty('--text-s','#4b5563');root.style.setProperty('--text-m','#6b7280');if(loginLogo)loginLogo.src='bridge-logo-nav.png'}}

function nav(p,pr={}){S.p=p;S.pr=pr;document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));const e=document.querySelector(`.nav-item[data-page="${p}"]`);if(e)e.classList.add('active');render()}
async function F(u){if(S.c[u])return S.c[u];try{const r=await fetch(u);const d=await r.json();S.c[u]=d;return d}catch(e){console.error(e);return null}}
function DC(){Object.values(CH).forEach(c=>c.destroy&&c.destroy());CH={}}
function v(x,suf='%'){return x!=null?x+suf:'‚Äì'}
function catB(c){return c==='Weekly Commentary'?'b-green':c==='Regulatory'?'b-amber':'b-blue'}
function riskB(r){return r<=3?'b-green':r<=5?'b-blue':r<=7?'b-amber':'b-red'}
function pId(n){return n.toLowerCase().replace(/ investors/,'').replace(/ /g,'-')}
function shortName(n){return n.replace('Quilter WealthSelect Active ','').replace('Managed ','')}
function removeBV(){const el=document.getElementById('bv-inline');if(el)el.remove()}
function toggleBV(){}
function renderBV(content){removeBV();if(!content)return;const tc=$('tc');if(!tc)return;const div=document.createElement('div');div.id='bv-inline';div.className='bv-inline';div.innerHTML=`<div class="bv-inline-header">üí° Bridge View</div><div class="bv-inline-content">${content}</div>`;tc.prepend(div)}
function fmtArticle(t){if(!t)return'<p style="color:var(--text-m)">Content to be added.</p>';return t.split('\n\n').map(p=>{p=p.trim();if(!p)return'';if(p.startsWith('**')&&p.endsWith('**'))return`<h3>${p.replace(/\*\*/g,'')}</h3>`;let h=p.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');if(h.includes('\n‚Ä¢')||h.startsWith('‚Ä¢')){const lines=h.split('\n');let out='',inUl=false;lines.forEach(l=>{l=l.trim();if(l.startsWith('‚Ä¢')){if(!inUl){out+='<ul>';inUl=true}out+=`<li>${l.slice(1).trim()}</li>`}else{if(inUl){out+='</ul>';inUl=false}if(l)out+=`<p>${l}</p>`}});if(inUl)out+='</ul>';return out}return`<p>${h.replace(/\n/g,'<br>')}</p>`}).join('')}

async function render(){
const el=$('app'),tt=$('tt');DC();removeBV();el.innerHTML='<div class="loading"><div class="spinner"></div>Loading...</div>';
switch(S.p){
case'dashboard':tt.textContent='Homepage';await rDash(el);break;
case'selection':tt.textContent='MPS Selection';await rSel(el);break;
case'analysis':tt.textContent='MPS Analysis';await rAna(el);break;
case'provider':tt.textContent='MPS Analysis';await rProv(el);break;
case'insights':tt.textContent='Insights';await rIns(el);break;
case'insight':tt.textContent='Insight';await rInsD(el);break;
case'messages':tt.textContent='Messages';await rMsg(el);break;
case'account':tt.textContent='Preferences';await rAcct(el);break;
default:tt.textContent='Homepage';await rDash(el);
}}

// ‚îÄ‚îÄ‚îÄ Homepage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rDash(el){
el.innerHTML=`<div class="fi"><div class="ph1"><h1>Bridge</h1><p>Independent MPS research and oversight for UK financial adviser firms</p></div>
<div class="grid g2" style="margin-bottom:28px">
<div class="card hp-card" style="cursor:pointer;position:relative" onclick="nav('analysis')" onmouseenter="showTip(this)" onmouseleave="hideTip(this)">
<div class="card-b" style="text-align:center;padding:32px 22px">
<div style="width:48px;height:48px;border-radius:12px;background:var(--accent-g);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><rect x="2" y="4" width="20" height="4" rx="1"/><rect x="2" y="10" width="20" height="4" rx="1"/><rect x="2" y="16" width="20" height="4" rx="1"/></svg></div>
<div style="font-size:16px;font-weight:600;margin-bottom:6px">MPS Analysis</div>
<div style="font-size:13px;color:var(--text-s);line-height:1.5">Explore detailed, independent analysis of individual MPS ranges.</div>
</div>
<div class="hp-tip" style="display:none;position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--accent);border-radius:var(--rs);padding:10px 14px;font-size:12px;color:var(--text-s);white-space:nowrap;z-index:10;margin-bottom:8px">Explore our MPS Analysis tool, providing comprehensive, independent research on managed portfolio services.</div>
</div>
<div class="card" style="cursor:pointer" onclick="nav('selection')">
<div class="card-b" style="text-align:center;padding:32px 22px">
<div style="width:48px;height:48px;border-radius:12px;background:var(--green-bg);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/></svg></div>
<div style="font-size:16px;font-weight:600;margin-bottom:6px">MPS Selection</div>
<div style="font-size:13px;color:var(--text-s);line-height:1.5">Filter the MPS universe by risk profiling tool, platform availability and investment style.</div>
</div></div>
</div>
<div id="hp-subs"></div>
<div id="hp-ins"></div>
<div style="border:1px solid var(--border);border-radius:var(--r);overflow:hidden">
<div class="exp-row" onclick="togExp(this)" style="display:flex;align-items:center;justify-content:space-between;padding:14px 20px;cursor:pointer;border-bottom:1px solid var(--border)">
<span style="font-size:13.5px;font-weight:500">Submit feedback</span>
<span class="exp-arr" style="color:var(--text-m);font-size:12px;transition:transform .2s">‚ñ∏</span></div>
<div class="exp-body" style="display:none;padding:20px;border-bottom:1px solid var(--border)">
<div style="display:flex;flex-direction:column;gap:12px">
<div class="fg"><span class="fl">Subject</span><input type="text" id="fb-subj" placeholder="e.g. Feature request, Bug report..." style="width:100%"></div>
<div class="fg"><span class="fl">Message</span><textarea id="fb-msg" rows="4" placeholder="Your feedback..." style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--rs);padding:10px 12px;font-size:13px;color:var(--text);font-family:inherit;outline:none;resize:vertical;width:100%;transition:border-color .15s" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></textarea></div>
<div style="display:flex;gap:10px;align-items:center"><button class="btn btn-p" onclick="sendFb()">Send Feedback</button><span id="fb-status" style="font-size:12px;color:var(--text-m)"></span></div>
</div></div>
<div class="exp-row" onclick="togExp(this)" style="display:flex;align-items:center;justify-content:space-between;padding:14px 20px;cursor:pointer">
<span style="font-size:13.5px;font-weight:500">How to use the tool</span>
<span class="exp-arr" style="color:var(--text-m);font-size:12px;transition:transform .2s">‚ñ∏</span></div>
<div class="exp-body" style="display:none;padding:16px 20px;font-size:13px;color:var(--text-s);line-height:1.6">
Use <strong>MPS Analysis</strong> to explore provider-level research across 8 structured tabs. Use <strong>MPS Selection</strong> to filter the universe by platform, fund selection approach, risk rating provider, and risk level. Use <strong>Insights</strong> to access weekly commentary and thematic analysis.</div>
</div></div>`
const ins=await F('/api/insights');if(ins&&ins.insights.length){
const hpi=document.getElementById('hp-ins');if(hpi)hpi.innerHTML=`
<div class="card" style="margin-bottom:28px"><div class="card-h"><span class="card-t">Latest Insights</span><button class="btn btn-g btn-sm" onclick="nav('insights')">View All ‚Üí</button></div>
<div class="card-b"><div class="grid g3">
${ins.insights.slice(0,3).map(i=>`<div class="insight-card" onclick="nav('insight',{id:'${i.id}'})">
<div class="im"><span class="badge ${catB(i.category)}">${i.category}</span><span>${i.date}</span><span>${i.read_time_minutes} min</span></div>
<div class="it">${i.title}</div><div class="is">${i.summary.slice(0,120)}...</div></div>`).join('')}
</div></div></div>`}
// Subscribed MPS ranges widget
try{const sr=await fetch('/api/subscriptions');if(sr.ok){const sd=await sr.json();
const hps=document.getElementById('hp-subs');if(hps&&sd.subscriptions.length){hps.innerHTML=`
<div class="card" style="margin-bottom:28px"><div class="card-h"><span class="card-t">üìå Your Subscribed MPS Ranges</span><button class="btn btn-g btn-sm" onclick="nav('account')">Manage ‚Üí</button></div>
<div class="card-b"><div style="display:flex;gap:10px;flex-wrap:wrap">${sd.subscriptions.map(s=>`<div style="padding:10px 16px;background:var(--accent-g);border:1px solid rgba(37,99,235,.15);border-radius:var(--rs);cursor:pointer;transition:all .15s" onclick="nav('provider',{id:'${s.provider_id}'})" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='rgba(37,99,235,.15)'"><div style="font-size:13px;font-weight:600;color:var(--accent)">${s.provider_name}</div><div style="font-size:11px;color:var(--text-m);margin-top:2px">Subscribed ¬∑ Click to view</div></div>`).join('')}</div></div></div>`}}}catch(e){}}

function showTip(el){const t=el.querySelector('.hp-tip');if(t)t.style.display='block'}
function hideTip(el){const t=el.querySelector('.hp-tip');if(t)t.style.display='none'}
function togExp(row){const body=row.nextElementSibling;const arr=row.querySelector('.exp-arr');
if(body.style.display==='none'){body.style.display='block';arr.textContent='‚ñæ'}
else{body.style.display='none';arr.textContent='‚ñ∏'}
const st=document.getElementById('fb-status');if(st)st.textContent=''}
async function sendFb(){
const subj=$('fb-subj').value.trim(),msg=$('fb-msg').value.trim(),st=$('fb-status');
if(!subj||!msg){st.style.color='var(--red)';st.textContent='Please fill in both fields.';return}
st.style.color='var(--text-m)';st.textContent='Sending...';
try{const r=await fetch('/api/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subject:subj,message:msg})});
if(r.ok){st.style.color='var(--green)';st.textContent='Feedback sent successfully.';$('fb-subj').value='';$('fb-msg').value=''}
else{const d=await r.json();st.style.color='var(--red)';st.textContent=d.detail||'Failed to send.'}}
catch(e){st.style.color='var(--red)';st.textContent='Failed to send. Please try again.'}}

// ‚îÄ‚îÄ‚îÄ MPS Selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rSel(el){
const f=await F('/api/selection/filters'),d=await F('/api/selection/mps?risk_min=1&risk_max=10');
if(!f||!d){el.innerHTML='<p>Failed to load</p>';return}
el.innerHTML=`<div class="fi"><div class="ph1"><h1>MPS Selection</h1><p>Filter the MPS universe to find solutions relevant for your firm</p></div>
<div class="filter-bar">
<div class="fg"><span class="fl">Platform</span><div class="ms-wrap" id="ms-plat"><button class="ms-btn" onclick="togMS('ms-plat')">All Platforms</button><div class="ms-dd">${f.platforms.map(p=>`<label class="ms-opt"><input type="checkbox" value="${p}" onchange="updMS('ms-plat');flt()"> ${p}</label>`).join('')}</div></div></div>
<div class="fg"><span class="fl">Fund Selection</span><select id="fs" onchange="flt()"><option value="">All</option>${(f.investment_styles||[]).map(s=>`<option>${s}</option>`).join('')}</select></div>
<div class="fg"><span class="fl">Risk Rating Provider</span><div class="ms-wrap" id="ms-rrp"><button class="ms-btn" onclick="togMS('ms-rrp')">All Providers</button><div class="ms-dd">${(f.risk_rating_providers||[]).map(r=>`<label class="ms-opt"><input type="checkbox" value="${r}" onchange="updMS('ms-rrp');flt()"> ${r}</label>`).join('')}</div></div></div>
<div class="fg" style="align-self:flex-end"><button class="btn btn-g btn-sm" onclick="rflt()">Reset</button></div>
</div>
<div class="card"><div class="card-h"><span class="card-t" id="mc">${grpRanges(d.mps).length} MPS Ranges</span></div>
<div style="padding:0"><div class="table-wrap"><table><thead><tr><th>MPS Range</th><th>Fund Selection</th><th>Risk Levels</th><th>All in Fee</th><th>Platforms</th></tr></thead>
<tbody id="mt">${mRows(d.mps)}</tbody></table></div></div></div></div>`}

function grpRanges(mps){const g={};mps.forEach(m=>{const rn=m.name.replace(/\s+\d+$/,'');if(!g[rn])g[rn]={name:rn,provider:m.provider,risks:[],ocfs:[],platforms:m.platforms||[],style:''};g[rn].risks.push(m.risk_rating);g[rn].ocfs.push(m.ocf)});return Object.values(g).map(r=>{r.risks.sort((a,b)=>a-b);return r})}
function mRows(mps){return grpRanges(mps).map(r=>`<tr class="cr" onclick="nav('provider',{id:'${pId(r.provider)}'})">
<td class="nc">${r.name}</td><td><span class="badge b-blue">Active</span></td>
<td>${r.risks[0]}-${r.risks[r.risks.length-1]}</td>
<td>${Math.min(...r.ocfs).toFixed(2)}% - ${Math.max(...r.ocfs).toFixed(2)}%</td>
<td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis">${r.platforms.join(', ')}</td></tr>`).join('')}

async function flt(){
let u='/api/selection/mps?risk_min=1&risk_max=10';
const selPlats=getMS('ms-plat');
if(selPlats.length)u+=`&platforms=${selPlats.join(',')}`;
delete S.c[u];const d=await F(u);if(!d)return;
let filtered=d.mps;
const fs=$('fs').value;
if(fs){const provs=await F('/api/providers');if(provs){const matchProvs=provs.providers.filter(p=>p.investment_style===fs).map(p=>p.name);filtered=filtered.filter(m=>matchProvs.includes(m.provider))}}
const selRRP=getMS('ms-rrp');
if(selRRP.length){const provs=await F('/api/providers');if(provs){const matchProvs=provs.providers.filter(p=>(p.risk_rating_providers||[]).some(r=>selRRP.includes(r))).map(p=>p.name);filtered=filtered.filter(m=>matchProvs.includes(m.provider))}}
const ranges=grpRanges(filtered);
$('mc').textContent=`${ranges.length} MPS Ranges`;$('mt').innerHTML=mRows(filtered)}

function rflt(){$('fs').value='';clearMS('ms-plat');clearMS('ms-rrp');flt()}

function togMS(id){const wrap=document.getElementById(id);if(!wrap)return;const dd=wrap.querySelector('.ms-dd');dd.classList.toggle('open');if(dd.classList.contains('open')){const close=e=>{if(!wrap.contains(e.target)){dd.classList.remove('open');document.removeEventListener('click',close)}};setTimeout(()=>document.addEventListener('click',close),0)}}
function getMS(id){const wrap=document.getElementById(id);if(!wrap)return[];return[...wrap.querySelectorAll('input:checked')].map(i=>i.value)}
function updMS(id){const wrap=document.getElementById(id);if(!wrap)return;const sel=getMS(id);const btn=wrap.querySelector('.ms-btn');const label=id==='ms-plat'?'Platforms':'Providers';btn.textContent=sel.length?`${sel.length} ${label} selected`:`All ${label}`}
function clearMS(id){const wrap=document.getElementById(id);if(!wrap)return;wrap.querySelectorAll('input').forEach(i=>i.checked=false);updMS(id)}

// ‚îÄ‚îÄ‚îÄ Analysis - Provider List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rAna(el){
const d=await F('/api/providers');if(!d){el.innerHTML='<p>Failed</p>';return}
el.innerHTML=`<div class="fi"><div class="ph1"><h1>MPS Analysis</h1><p>Structured analytical dashboards for each approved MPS provider</p></div>
<div class="grid g2">${d.providers.map(p=>`<div class="card" style="cursor:pointer" onclick="nav('provider',{id:'${p.id}'})">
<div class="card-b"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
<div><div style="font-size:18px;font-weight:700;font-family:'DM Sans',sans-serif;margin-bottom:2px">${p.name}</div>
<div style="font-size:13px;color:var(--text-s)">${p.full_name}</div></div>
<span class="badge b-blue">${p.investment_style}</span></div>
<div style="font-size:13px;color:var(--text-s);line-height:1.6;margin-bottom:16px">${p.description.slice(0,160)}...</div>
<div style="display:flex;gap:20px;font-size:12px">
<div><span style="color:var(--text-m)">Risk Levels </span><strong>${p.portfolio_count}</strong></div>
<div><span style="color:var(--text-m)">Risk </span><strong>${p.risk_range}</strong></div>
<div><span style="color:var(--text-m)">All in Fee </span><strong>${p.ocf_range}</strong></div>
</div></div></div>`).join('')}</div></div>`}

// ‚îÄ‚îÄ‚îÄ Provider Detail (8-tab layout) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rProv(el){
const id=S.pr?.id;if(!id){nav('analysis');return}
const d=await F(`/api/providers/${id}`);if(!d){el.innerHTML='<p>Not found</p>';return}
const p=d.provider,pts=d.portfolios;
S._provData=d;S._provTab='overview';
el.innerHTML=`<div class="fi"><div class="back" onclick="nav('analysis')">‚Üê Back to Providers</div>
<div class="ph"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="pn">${p.full_name||p.name}</div>
<div style="color:var(--text-s);font-size:14px;margin-bottom:8px">${p.name} ¬∑ ${p.investment_style}</div></div>
<button class="sub-btn unsubscribed" id="subBtn" onclick="togSub('${p.id}','${(p.full_name||p.name).replace(/'/g,"\\'")}')">üîî Subscribe</button></div></div>
<div class="tabs" id="ptabs">
<div class="tab active" onclick="pTab('overview')">Overview</div>
<div class="tab" onclick="pTab('investment')">Investment Process</div>
<div class="tab" onclick="pTab('current')">Current Exposure</div>
<div class="tab" onclick="pTab('historical')">Historical Exposure</div>
<div class="tab" onclick="pTab('performance')">Performance</div>
<div class="tab" onclick="pTab('cost')">Cost</div>
<div class="tab" onclick="pTab('adviser')">Adviser Support</div>
<div class="tab" onclick="pTab('quarterly')">Quarterly Review</div>
<div class="tab" onclick="pTab('consumer_duty')">Consumer Duty</div>
</div>
<div id="tc"></div></div>`;
// Check subscription state
try{const sr=await fetch(`/api/subscriptions/check/${p.id}`);if(sr.ok){const sd=await sr.json();
const btn=$('subBtn');if(btn&&sd.subscribed){btn.className='sub-btn subscribed';btn.innerHTML='‚úì Subscribed'}}}catch(e){}
pTab('overview')}

function pTab(tab){
S._provTab=tab;DC();removeBV();
document.querySelectorAll('#ptabs .tab').forEach(t=>t.classList.remove('active'));
const tabs=document.querySelectorAll('#ptabs .tab');
const tabMap=['overview','investment','current','historical','performance','cost','adviser','quarterly','consumer_duty'];
const idx=tabMap.indexOf(tab);if(idx>=0&&tabs[idx])tabs[idx].classList.add('active');
const tc=$('tc'),d=S._provData;if(!tc||!d)return;
const p=d.provider,pts=d.portfolios;
switch(tab){
case'overview':tabOverview(tc,p,pts);break;
case'investment':tabInvestment(tc,p);break;
case'current':tabCurrent(tc,pts);break;
case'historical':tabHistorical(tc);break;
case'performance':tabPerformance(tc,pts,p);break;
case'cost':tabCost(tc,pts);break;
case'adviser':tabAdviser(tc,p);break;
case'quarterly':tabQuarterly(tc,p);break;
case'consumer_duty':tabConsumerDuty(tc,p,pts);break;
}}

// ‚îÄ‚îÄ‚îÄ Overview Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tabOverview(tc,p,pts){
const rrp=p.risk_rating_providers||[];
tc.innerHTML=`
<div class="grid g2" style="margin-bottom:20px">
<div class="stat-card"><div class="stat-l">Risk Levels</div><div class="stat-v">${pts.length}</div></div>
<div class="stat-card"><div class="stat-l">All in Fee</div><div class="stat-v">${Math.min(...pts.map(m=>m.ocf)).toFixed(2)}% ‚Äì ${Math.max(...pts.map(m=>m.ocf)).toFixed(2)}%</div></div>
</div>
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Provider Details</span></div>
<div class="card-b" style="padding:0"><table><thead><tr><th>Firm</th><th>Fund Selection</th><th>Management Fee</th>${p.established?'<th>Established</th>':''}${p.regulatory_status?'<th>Status</th>':''}</tr></thead>
<tbody><tr><td class="nc">${p.name}</td><td>${p.investment_style||'‚Äì'}</td><td>0.15%</td>${p.established?`<td>${p.established}</td>`:''}${p.regulatory_status?`<td>${p.regulatory_status}</td>`:''}</tr></tbody></table></div></div>
${p.description?`<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Description</span></div><div class="card-b"><div class="article"><p>${p.description}</p></div></div></div>`:''}
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Model Range</span></div>
<div class="card-b" style="padding:0"><table><thead><tr><th>Model</th><th>Inception</th></tr></thead>
<tbody>${pts.map(m=>`<tr><td class="nc">${m.name}</td><td>${m.inception_date?new Date(m.inception_date).toLocaleDateString('en-GB'):'‚Äì'}</td></tr>`).join('')}</tbody></table></div></div>
<div class="grid g2">
<div class="card"><div class="card-h"><span class="card-t">Platform Availability</span></div>
<div class="card-b"><ul class="slist">${pts[0].platforms.map(pl=>`<li>${pl}</li>`).join('')}</ul></div></div>
${rrp.length?`<div class="card"><div class="card-h"><span class="card-t">Risk Rating Providers</span></div>
<div class="card-b"><ul class="slist">${rrp.map(r=>`<li>${r}</li>`).join('')}</ul></div></div>`:''}
</div>
${p.strengths&&p.strengths.length?`<div class="grid g2" style="margin-top:20px"><div class="card"><div class="card-h"><span class="card-t">Strengths</span></div><div class="card-b"><ul class="slist">${p.strengths.map(s=>`<li>${s}</li>`).join('')}</ul></div></div>
${p.considerations&&p.considerations.length?`<div class="card"><div class="card-h"><span class="card-t">Considerations</span></div><div class="card-b"><ul class="clist">${p.considerations.map(c=>`<li>${c}</li>`).join('')}</ul></div></div>`:''}</div>`:''}
<div class="card" style="margin-top:20px"><div class="card-h"><span class="card-t">üí¨ Have a Question?</span></div>
<div class="card-b"><p style="font-size:13.5px;color:var(--text-s);margin-bottom:14px">Ask the Bridge Research team about this MPS provider, we typically respond within 1 business day.</p>
<div class="msg-form" id="askForm">
<input type="text" id="askSubj" placeholder="Subject, e.g. 'Question about rebalancing approach'">
<textarea id="askMsg" placeholder="Your question..."></textarea>
<div style="display:flex;gap:10px;align-items:center"><button class="btn btn-p" onclick="sendAsk()">Send Question</button><span id="askStatus" style="font-size:12px;color:var(--text-m)"></span></div>
</div></div></div>`}

// ‚îÄ‚îÄ‚îÄ Investment Process Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tabInvestment(tc,p){
const ip=p.investment_process||{};
const sections=[
{title:'Investment Team',key:'investment_team'},
{title:'Strategic Asset Allocation',key:'strategic_aa'},
{title:'Tactical Asset Allocation',key:'tactical_aa'},
{title:'Fund Selection',key:'fund_selection'},
{title:'Portfolio Construction',key:'portfolio_construction'},
{title:'Rebalancing & Trading',key:'rebalancing'}
];
tc.innerHTML=sections.map(s=>`<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">${s.title}</span></div>
<div class="card-b"><div class="article">${fmtArticle(ip[s.key])}</div></div></div>`).join('');
renderBV(`<p><strong>Bridge View: Investment Process</strong></p><p>Quilter's investment process is comprehensive, built around a centralised Manager Research Hub with dedicated teams for quantitative analysis, operational due diligence, and responsible investment.</p><p>The use of WTW capital market assumptions for SAA adds rigour, while quarterly TAA reviews allow tactical flexibility within defined risk guardrails.</p><p>The sub-advised fund structure is a notable feature ‚Äî it provides continuity and tax efficiency that many competitors lack.</p><p>Areas to monitor: the breadth of the investment team relative to the number of portfolios managed, and whether TAA decisions are consistently adding value over SAA alone.</p>`)}

// ‚îÄ‚îÄ‚îÄ Current Exposure Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tabCurrent(tc,pts){
const defPort=pts[0];
tc.innerHTML=`
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Current Holdings</span>
<div style="display:flex;gap:8px;align-items:center"><span style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-m)">Risk Level</span><div class="fg"><select id="hp" onchange="chPort()">${pts.map((m,i)=>`<option value="${i}">${shortName(m.name)}</option>`).join('')}</select></div></div></div>
<div class="card-b" style="padding:0"><div class="table-wrap"><table><thead><tr><th>Fund Name</th><th>ISIN</th><th>Portfolio Weighting (%)</th><th>Asset Class</th><th>Sub Asset Class</th></tr></thead>
<tbody id="ht">${holdRows(defPort,true)}</tbody></table></div>
<div id="holdToggle" style="padding:12px 14px;text-align:center;border-top:1px solid var(--border)"><a href="#" onclick="expandHold(event)" id="holdBtn" style="color:var(--accent);font-size:12px;font-weight:500;text-decoration:none">Show all ${defPort.underlying_funds?defPort.underlying_funds.length:0} holdings ‚ñæ</a></div></div></div>
<div class="grid g2">
<div class="card"><div class="card-h"><span class="card-t">Equity Exposure</span>
<div class="fg"><select id="eqMode" onchange="chEqMode()" style="min-width:110px"><option value="abs">Absolute</option><option value="prop">Proportion</option></select></div></div>
<div class="card-b" style="padding:0"><div class="table-wrap"><table><thead><tr><th>Region</th>${pts.map(m=>`<th>${shortName(m.name)}</th>`).join('')}</tr></thead>
<tbody id="eqt">${eqRows(pts,'abs')}</tbody></table></div></div></div>
<div class="card"><div class="card-h"><span class="card-t">Fixed Income Exposure</span>
<div class="fg"><select id="fiMode" onchange="chFiMode()" style="min-width:110px"><option value="abs">Absolute</option><option value="prop">Proportion</option></select></div></div>
<div class="card-b" style="padding:0"><div class="table-wrap"><table><thead><tr><th>Type</th>${pts.map(m=>`<th>${shortName(m.name)}</th>`).join('')}</tr></thead>
<tbody id="fit">${fiRows(pts,'abs')}</tbody></table></div></div></div>
</div>`;
S._holdExpanded=false;
renderBV(`<p><strong>Bridge View: Current Exposure</strong></p><p>The current holdings reveal Quilter's active approach to portfolio construction, with a blend of sub-advised mandates and third-party funds.</p><p>Equity exposure tilts towards global developed markets, with a meaningful UK allocation that provides domestic anchoring. The fixed income allocation favours investment-grade sterling credit with selective duration management.</p><p>Key observations: diversification across managers reduces single-manager risk, and the use of sub-advised structures provides operational efficiency advantages.</p>`)}

function holdRows(m,limit){
if(!m.underlying_funds||!m.underlying_funds.length)return'<tr><td colspan="5">No holdings data</td></tr>';
const funds=limit&&!S._holdExpanded?m.underlying_funds.slice(0,10):m.underlying_funds;
return funds.map(f=>{const subBadge=f.sub_type?`<span class="badge ${f.type==='Equity'?'b-blue':f.type==='Fixed Income'?'b-green':f.type==='Alternative'?'b-purple':'b-amber'}" style="opacity:.7">${f.sub_type}</span>`:'‚Äì';return`<tr><td class="nc">${f.name}</td><td>${f.isin||'‚Äì'}</td><td>${f.weight}</td>
<td><span class="badge ${f.type==='Equity'?'b-blue':f.type==='Fixed Income'?'b-green':f.type==='Alternative'?'b-purple':'b-amber'}">${f.type}</span></td>
<td>${subBadge}</td></tr>`}).join('')}

function expandHold(e){e.preventDefault();S._holdExpanded=!S._holdExpanded;const idx=$('hp').value;const m=S._provData.portfolios[idx];$('ht').innerHTML=holdRows(m,true);const btn=$('holdBtn');if(btn)btn.innerHTML=S._holdExpanded?'Show top 10 ‚ñ¥':`Show all ${m.underlying_funds?m.underlying_funds.length:0} holdings ‚ñæ`}

function chPort(){
S._holdExpanded=false;const idx=$('hp').value;const m=S._provData.portfolios[idx];
$('ht').innerHTML=holdRows(m,true);const btn=$('holdBtn');if(btn)btn.innerHTML=`Show all ${m.underlying_funds?m.underlying_funds.length:0} holdings ‚ñæ`}

function eqRows(pts,mode){
const regions=new Set();
pts.forEach(m=>{if(m.geographic_allocation)Object.keys(m.geographic_allocation).forEach(k=>regions.add(k))});
return[...regions].map(r=>{
const vals=pts.map(m=>m.geographic_allocation&&m.geographic_allocation[r]!=null?m.geographic_allocation[r]:0);
if(mode==='prop'){const totals=pts.map(m=>{if(!m.geographic_allocation)return 1;return Object.values(m.geographic_allocation).reduce((s,v)=>s+(v||0),0)||1});
return`<tr><td class="nc">${r.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</td>${pts.map((m,i)=>`<td>${vals[i]>0?(vals[i]/totals[i]*100).toFixed(1)+'%':'‚Äì'}</td>`).join('')}</tr>`}
return`<tr><td class="nc">${r.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</td>${vals.map(v=>`<td>${v>0?v.toFixed(2):'‚Äì'}</td>`).join('')}</tr>`}).join('')}

function fiRows(pts,mode){
const types=new Set();
pts.forEach(m=>{if(m.fixed_income_breakdown)Object.keys(m.fixed_income_breakdown).forEach(k=>types.add(k))});
return[...types].map(t=>{
const vals=pts.map(m=>m.fixed_income_breakdown&&m.fixed_income_breakdown[t]!=null?m.fixed_income_breakdown[t]:0);
if(mode==='prop'){const totals=pts.map(m=>{if(!m.fixed_income_breakdown)return 1;return Object.values(m.fixed_income_breakdown).reduce((s,v)=>s+(v||0),0)||1});
return`<tr><td class="nc">${t.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</td>${pts.map((m,i)=>`<td>${vals[i]>0?(vals[i]/totals[i]*100).toFixed(1)+'%':'‚Äì'}</td>`).join('')}</tr>`}
return`<tr><td class="nc">${t.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</td>${vals.map(v=>`<td>${v>0?v.toFixed(2):'‚Äì'}</td>`).join('')}</tr>`}).join('')}

function chEqMode(){$('eqt').innerHTML=eqRows(S._provData.portfolios,$('eqMode').value)}
function chFiMode(){$('fit').innerHTML=fiRows(S._provData.portfolios,$('fiMode').value)}

// ‚îÄ‚îÄ‚îÄ Historical Exposure Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tabHistorical(tc){
const h=await F('/api/historical/portfolio_7');
tc.innerHTML=`
<div style="margin-bottom:16px;padding:12px 16px;background:var(--accent-g);border-radius:var(--rs);font-size:13px;color:var(--accent);font-weight:500">üìä Showing historical data for <strong>Risk Level 7</strong> (Balanced)</div>
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Asset Allocation ‚Äì Risk Level 7</span></div>
<div class="card-b"><div class="cc" style="height:320px"><canvas id="haa"></canvas></div></div></div>
<div class="grid g2">
<div class="card"><div class="card-h"><span class="card-t">Equity Exposure ‚Äì Risk Level 7</span></div>
<div class="card-b"><div class="cc" style="height:280px"><canvas id="heq"></canvas></div></div></div>
<div class="card"><div class="card-h"><span class="card-t">Fixed Income Exposure ‚Äì Risk Level 7</span></div>
<div class="card-b"><div class="cc" style="height:280px"><canvas id="hfi"></canvas></div></div></div>
</div>`;
renderBV(`<p><strong>Bridge View: Historical Exposure</strong></p><p>Historical asset allocation data shows how the portfolio has evolved over time. Gradual shifts in equity/bond weighting reflect both strategic reviews and tactical positioning.</p><p>The equity regional breakdown shows any geographic rotation decisions, while the fixed income history highlights duration and credit quality positioning through different rate environments.</p><p>Look for consistency between the stated investment approach and the actual changes observed ‚Äî significant deviations may warrant further investigation.</p>`);
const hoverLine={id:'hoverLine',beforeDatasetsDraw(chart){const{ctx,chartArea:{left,right,top,bottom}}=chart;const active=chart.tooltip?.getActiveElements();if(active&&active.length){const x=active[0].element.x;ctx.save();ctx.beginPath();ctx.moveTo(x,top);ctx.lineTo(x,bottom);ctx.lineWidth=1;ctx.strokeStyle='rgba(107,114,128,.3)';ctx.setLineDash([4,3]);ctx.stroke();ctx.restore()}}};
const ttOpts={mode:'index',intersect:false,callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y!=null?ctx.parsed.y.toFixed(1)+'%':'‚Äì'}`}};
if(!h)return;
setTimeout(()=>{
if(h.asset_allocation){
const aa=h.asset_allocation;
const labels=aa.map(d=>d.Date);
CH.haa=new Chart($('haa'),{type:'line',data:{labels,datasets:[
{label:'Equity',data:aa.map(d=>d.Equity),backgroundColor:'rgba(59,130,246,.4)',borderColor:'rgba(59,130,246,.8)',fill:true,tension:.3,pointRadius:0},
{label:'Fixed Income',data:aa.map(d=>d['Fixed Income']),backgroundColor:'rgba(139,92,246,.4)',borderColor:'rgba(139,92,246,.8)',fill:true,tension:.3,pointRadius:0},
{label:'Alternative',data:aa.map(d=>d.Alternative),backgroundColor:'rgba(16,185,129,.4)',borderColor:'rgba(16,185,129,.8)',fill:true,tension:.3,pointRadius:0},
{label:'Cash',data:aa.map(d=>d.Cash),backgroundColor:'rgba(245,158,11,.4)',borderColor:'rgba(245,158,11,.8)',fill:true,tension:.3,pointRadius:0}
]},plugins:[hoverLine],options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#4b5563',font:{size:11}}},tooltip:ttOpts},scales:{x:{ticks:{color:'#6b7280',maxTicksLimit:12,font:{size:10}},grid:{display:false}},y:{stacked:true,max:100,ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}}}}})
}
if(h.equity_region){
const eq=h.equity_region;const labels=eq.map(d=>d.Date);
const keys=Object.keys(eq[0]).filter(k=>k!=='Date');
const colors=['rgba(59,130,246,.5)','rgba(16,185,129,.5)','rgba(245,158,11,.5)','rgba(239,68,68,.5)','rgba(139,92,246,.5)','rgba(6,182,212,.5)','rgba(168,85,247,.5)'];
CH.heq=new Chart($('heq'),{type:'line',data:{labels,datasets:keys.map((k,i)=>({label:k,data:eq.map(d=>d[k]||0),backgroundColor:colors[i%7],borderColor:colors[i%7].replace('.5','.8'),fill:true,tension:.3,pointRadius:0}))},plugins:[hoverLine],options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#4b5563',font:{size:10}}},tooltip:ttOpts},scales:{x:{ticks:{color:'#6b7280',maxTicksLimit:10,font:{size:9}},grid:{display:false}},y:{stacked:true,ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}}}}})
}
if(h.fixed_income){
const fi=h.fixed_income;const labels=fi.map(d=>d.Date);
const keys=Object.keys(fi[0]).filter(k=>k!=='Date');
const colors=['rgba(59,130,246,.5)','rgba(139,92,246,.5)','rgba(16,185,129,.5)','rgba(239,68,68,.5)','rgba(245,158,11,.5)','rgba(6,182,212,.5)','rgba(168,85,247,.5)'];
CH.hfi=new Chart($('hfi'),{type:'line',data:{labels,datasets:keys.map((k,i)=>({label:k,data:fi.map(d=>d[k]||0),backgroundColor:colors[i%7],borderColor:colors[i%7].replace('.5','.8'),fill:true,tension:.3,pointRadius:0}))},plugins:[hoverLine],options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#4b5563',font:{size:10}}},tooltip:ttOpts},scales:{x:{ticks:{color:'#6b7280',maxTicksLimit:10,font:{size:9}},grid:{display:false}},y:{stacked:true,ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}}}}})
}
},100)}

// ‚îÄ‚îÄ‚îÄ Performance Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tabPerformance(tc,pts,p){
const years=['YTD','2025','2024','2023','2022','2021','2020','2019','2018','2017','2016'];
const rrData=p.risk_return_data||[];
const periods=[...new Set(rrData.map(d=>d.period))];
tc.innerHTML=`
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Calendar Year Returns (%)</span></div>
<div class="card-b" style="padding:0"><div class="table-wrap"><table><thead><tr><th>Model</th>${years.map(y=>`<th>${y}</th>`).join('')}</tr></thead>
<tbody>${pts.map(m=>{const cr=m.calendar_returns||{};return`<tr><td class="nc">${m.name}</td>${years.map(y=>{const val=cr[y];return`<td style="color:${val!=null&&val<0?'var(--red)':'var(--text-s)'}">${val!=null?val+'%':'‚Äì'}</td>`}).join('')}</tr>`}).join('')}</tbody></table></div></div></div>
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Trailing Returns (%)</span></div>
<div class="card-b" style="padding:0"><div class="table-wrap"><table><thead><tr><th>Model</th><th>1M</th><th>3M</th><th>6M</th><th>YTD</th><th>1Y</th><th>3Y</th><th>5Y</th><th>10Y</th></tr></thead>
<tbody>${pts.map(m=>{const tr=m.trailing_returns||{};return`<tr><td class="nc">${m.name}</td><td>${v(tr['1M'])}</td><td>${v(tr['3M'])}</td><td>${v(tr['6M'])}</td><td>${v(tr['YTD'])}</td><td>${v(tr['1Y'])}</td><td>${v(tr['3Y'])}</td><td>${v(tr['5Y'])}</td><td>${v(tr['10Y'])}</td></tr>`}).join('')}</tbody></table></div></div></div>
<div class="card"><div class="card-h"><span class="card-t">Risk vs Return</span>
${periods.length?`<div class="fg"><select id="rrPeriod" onchange="updateRvR()" style="min-width:140px">${periods.map((p,i)=>`<option value="${p}" ${i===0?'selected':''}>${p}</option>`).join('')}</select></div>`:''}</div>
<div class="card-b"><div id="rrDateRange" style="font-size:12px;color:var(--text-m);margin-bottom:8px;font-weight:500"></div><div class="cc" style="height:340px"><canvas id="rvr"></canvas></div></div></div>`;
S._rrData=rrData;
renderBV(`<p><strong>Bridge View: Performance</strong></p><p>Calendar year returns show the portfolio's behaviour through different market environments. Pay attention to 2022 (a challenging year for multi-asset) and subsequent recovery.</p><p>The risk/return scatter chart plots annualised risk against annualised return, with IA sector benchmarks for context. Portfolios above and to the left of the benchmark line are delivering superior risk-adjusted returns.</p><p>Quilter's active portfolios have generally clustered above the IA sector line, suggesting the active management approach has added value on a risk-adjusted basis over these periods.</p>`);
setTimeout(()=>{updateRvR()},100)}

function updateRvR(){
const ctx=$('rvr');if(!ctx)return;if(CH.rvr)CH.rvr.destroy();
const period=$('rrPeriod')?$('rrPeriod').value:(S._rrData.length?S._rrData[0].period:'3 Year');
const filtered=S._rrData.filter(d=>d.period===period);
const quilter=filtered.filter(d=>d.portfolio.startsWith('Quilter'));
const benchmarks=filtered.filter(d=>!d.portfolio.startsWith('Quilter'));
// Show date range
const drEl=$('rrDateRange');if(drEl){const now=new Date();const end='31/12/'+now.getFullYear();let start='';const match=period.match(/(\d+)/);if(match){const yrs=parseInt(match[1]);start='31/12/'+(now.getFullYear()-yrs)}else if(period.toLowerCase().includes('inception')){start='24/02/2014'}else{start='31/12/'+(now.getFullYear()-3)}drEl.textContent=`Period: ${start} ‚Äì ${end}`}
CH.rvr=new Chart(ctx,{type:'scatter',data:{datasets:[
{label:'Quilter Portfolios',data:quilter.map(d=>({x:d.risk,y:d.return})),backgroundColor:'rgba(59,130,246,.8)',pointRadius:8,pointHoverRadius:10},
{label:'IA Sectors',data:benchmarks.map(d=>({x:d.risk,y:d.return})),backgroundColor:'rgba(245,158,11,.7)',pointRadius:7,pointHoverRadius:9,pointStyle:'triangle'}
]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#4b5563',font:{size:11}}},tooltip:{callbacks:{label:ctx2=>{const i=ctx2.dataIndex;const src=ctx2.datasetIndex===0?quilter:benchmarks;const d=src[i];if(!d)return'';const name=d.portfolio.replace('Quilter WealthSelect Active Managed ','Portfolio ');return`${name}: Risk ${d.risk.toFixed(1)}%, Return ${d.return.toFixed(1)}%`}}}},scales:{x:{title:{display:true,text:'Annualised Risk (%)',color:'#6b7280'},ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}},y:{title:{display:true,text:'Annualised Return (%)',color:'#6b7280'},ticks:{color:'#6b7280'},grid:{color:'#e5e7eb'}}}}})}

// ‚îÄ‚îÄ‚îÄ Cost Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tabCost(tc,pts){
tc.innerHTML=`
<div class="card"><div class="card-h"><span class="card-t">Cost Breakdown</span></div>
<div class="card-b" style="padding:0"><div class="table-wrap"><table><thead><tr><th>Model</th><th>DFM</th><th>Underlying</th><th>All In</th></tr></thead>
<tbody>${pts.map(m=>{const c=m.cost_breakdown||{};return`<tr><td class="nc">${m.name}</td><td>${c.dfm!=null?c.dfm.toFixed(2):'‚Äì'}</td><td>${c.underlying!=null?c.underlying.toFixed(2):'‚Äì'}</td><td><strong>${c.all_in!=null?c.all_in.toFixed(2):'‚Äì'}</strong></td></tr>`}).join('')}</tbody></table></div></div></div>`;
renderBV(`<p><strong>Bridge View: Costs</strong></p><p>The management fee of 0.15% is competitive within the active MPS space. The all-in fee range of 0.60% to 0.83% reflects the varying underlying fund costs across different risk levels.</p><p>Higher risk portfolios (8-10) carry slightly higher underlying fund costs due to greater use of actively managed equity funds, while lower risk portfolios benefit from more cost-efficient fixed income allocations.</p><p>When comparing costs, consider the total cost to the client inclusive of platform charges and adviser fees, not the MPS cost in isolation.</p>`)}

function tabConsumerDuty(tc,p,pts){
const provName=p.full_name||p.name;
const today=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
tc.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<div><div style="font-size:16px;font-weight:600">Consumer Duty Oversight Report</div>
<div style="font-size:13px;color:var(--text-m)">Editable template ‚Äî click any section to customise before exporting</div></div>
<button class="btn btn-p" onclick="exportCD()">Export Report</button>
</div>
<div class="card" style="margin-bottom:16px"><div class="card-h"><span class="card-t">üìã Report Details</span></div>
<div class="card-b" style="padding:0"><table>
<tr><td class="nc" style="width:180px">Provider</td><td>${provName}</td></tr>
<tr><td class="nc">Date</td><td>${today}</td></tr>
<tr><td class="nc">Risk Levels Covered</td><td>${pts.map(m=>m.risk_rating).join(', ')}</td></tr>
<tr><td class="nc">All-in Fee Range</td><td>${Math.min(...pts.map(m=>m.ocf)).toFixed(2)}% ‚Äì ${Math.max(...pts.map(m=>m.ocf)).toFixed(2)}%</td></tr>
</table></div></div>
<div class="card" style="margin-bottom:16px"><div class="card-h"><span class="card-t">1. Selection Rationale</span></div>
<div class="cd-editable" contenteditable="true" data-placeholder="Document why this MPS was selected for your firm's approved list...">${provName} was selected following an independent assessment of the investment process, cost structure, platform availability, and alignment with our client segments. The proposition offers a comprehensive active managed solution across risk levels ${pts[0].risk_rating} to ${pts[pts.length-1].risk_rating}, available on ${pts[0].platforms.length} platforms.</div></div>
<div class="card" style="margin-bottom:16px"><div class="card-h"><span class="card-t">2. Target Market & Suitability</span></div>
<div class="cd-editable" contenteditable="true" data-placeholder="Define which client segments this MPS is suitable for...">This MPS range is suitable for clients seeking a professionally managed, diversified multi-asset portfolio with active fund selection. The range spans risk levels ${pts[0].risk_rating} to ${pts[pts.length-1].risk_rating}, making it appropriate for clients across cautious to adventurous risk profiles with a medium to long-term investment horizon.</div></div>
<div class="card" style="margin-bottom:16px"><div class="card-h"><span class="card-t">3. Fair Value Assessment</span></div>
<div class="cd-editable" contenteditable="true" data-placeholder="Assess whether the costs represent fair value for clients...">The all-in fee range of ${Math.min(...pts.map(m=>m.ocf)).toFixed(2)}% to ${Math.max(...pts.map(m=>m.ocf)).toFixed(2)}% is assessed as representing fair value given the depth of the investment process, breadth of manager research, and the active management approach. The management fee of 0.15% is competitive within the active MPS universe.</div></div>
<div class="card" style="margin-bottom:16px"><div class="card-h"><span class="card-t">4. Ongoing Monitoring Summary</span></div>
<div class="cd-editable" contenteditable="true" data-placeholder="Summarise monitoring activity and findings...">Portfolios have been monitored on a quarterly basis. Performance has been reviewed against relevant IA sector benchmarks and peer groups. Asset allocation changes and fund selection decisions have been assessed for consistency with the stated investment approach.</div></div>
<div class="card" style="margin-bottom:16px"><div class="card-h"><span class="card-t">5. Actions & Conclusions</span></div>
<div class="cd-editable" contenteditable="true" data-placeholder="Record any actions taken or conclusions reached...">Based on the current review, ${provName} remains appropriate for the target client segments identified above. No changes to the approved list are recommended at this time. Next review scheduled in accordance with our quarterly monitoring cadence.</div></div>
`}

async function exportCD(){
const btn=event.target;btn.textContent='Generating...';btn.disabled=true;
try{
const rows=document.querySelectorAll('.card-b table tr');
const details={};
rows.forEach(r=>{const cells=r.querySelectorAll('td');if(cells.length===2)details[cells[0].innerText.trim()]=cells[1].innerText.trim()});
const sections=[];
document.querySelectorAll('.cd-editable').forEach(el=>{
const card=el.closest('.card');
const title=card?card.querySelector('.card-t')?.innerText.trim():'';
sections.push({title,content:el.innerText.trim()})});
const res=await fetch('/api/export/consumer-duty',{method:'POST',headers:{'Content-Type':'application/json'},
body:JSON.stringify({details,sections})});
if(!res.ok)throw new Error('Export failed');
const blob=await res.blob();
const a=document.createElement('a');a.href=URL.createObjectURL(blob);
a.download='Consumer_Duty_Oversight_Report.docx';a.click();
}catch(e){alert('Export failed: '+e.message)}
finally{btn.textContent='Export Report';btn.disabled=false}}

// ‚îÄ‚îÄ‚îÄ Adviser Support Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tabAdviser(tc,p){
const as=p.adviser_support||{};
const websiteUrl=p.website||'';
const sections=[
{title:'Onboarding & Training',key:'onboarding'},
{title:'Ongoing Portfolio Communication',key:'ongoing_communication'},
{title:'Review Meetings & Ongoing Engagement',key:'review_meetings'},
{title:'Investment Commentary & Market Insight',key:'investment_commentary'},
{title:'Digital Tools & Support Infrastructure',key:'digital_tools'}
];
tc.innerHTML=`${websiteUrl?`<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Provider Website</span></div>
<div class="card-b"><a href="${websiteUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;color:var(--accent);font-size:14px;font-weight:500;text-decoration:none">üîó ${p.full_name||p.name} <span style="font-size:12px;color:var(--text-m)">‚Üó Opens in new tab</span></a></div></div>`:''}`+sections.map(s=>`<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">${s.title}</span></div>
<div class="card-b"><div class="article">${fmtArticle(as[s.key])}</div></div></div>`).join('');
renderBV(`<p><strong>Bridge View: Adviser Support</strong></p><p>Quilter provides a comprehensive support offering spanning onboarding, ongoing communication, and digital infrastructure. The breadth of support is above average for the MPS market.</p><p>Quarterly rebalance documentation and post-trade rationale are particularly valuable for Consumer Duty evidence requirements. The availability of both virtual and in-person training adds flexibility.</p><p>Consider: how responsive is the Quilter team to ad-hoc queries? Adviser firms should test the support model during the evaluation phase rather than relying solely on the documented offering.</p>`)}

// ‚îÄ‚îÄ‚îÄ Quarterly Review Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tabQuarterly(tc,p){
const qr=p.quarterly_review||{};
tc.innerHTML=`
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Asset Allocation Changes</span></div>
<div class="card-b"><div class="article">${fmtArticle(qr.aa_changes)}</div></div></div>
<div class="card" style="margin-bottom:20px"><div class="card-h"><span class="card-t">Fund Selection Changes</span></div>
<div class="card-b"><div class="article">${fmtArticle(qr.fund_changes)}</div></div></div>
<div class="card"><div class="card-h"><span class="card-t">Performance Review</span></div>
<div class="card-b"><div class="article">${fmtArticle(qr.performance_review)}</div></div></div>`}

// ‚îÄ‚îÄ‚îÄ Insights ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rIns(el){
const d=await F('/api/insights');if(!d){el.innerHTML='<p>Failed</p>';return}
const pinned=d.insights.filter(i=>i.pinned);
const regular=d.insights.filter(i=>!i.pinned);
el.innerHTML=`<div class="fi"><div class="ph1"><h1>Insights</h1><p>Expert insights from Buckingham Research ‚Äî market theme analysis and ad-hoc thought pieces</p></div>
${pinned.length?`<div class="card" style="margin-bottom:24px;border-color:rgba(37,99,235,.25)"><div class="card-h" style="background:var(--accent-g)"><span class="card-t" style="display:flex;align-items:center;gap:8px">üì∞ Latest Weekly Market Update</span><span style="font-size:12px;color:var(--text-m)">Updated ${pinned[0].date}</span></div>
<div class="card-b" style="cursor:pointer" onclick="nav('insight',{id:'${pinned[0].id}'})">
<div class="it" style="margin-bottom:6px">${pinned[0].title}</div>
<div class="is">${pinned[0].summary}</div>
<div style="margin-top:10px;font-size:12px;color:var(--accent);font-weight:500">Read full update ‚Üí</div>
</div></div>`:''}
<div class="filter-bar" style="margin-bottom:24px">
<div class="fg"><span class="fl">Category</span><select id="ic" onchange="fIns()"><option value="">All</option>${d.categories.map(c=>`<option>${c}</option>`).join('')}</select></div>
</div>
<div class="grid g2" id="il">${insCards(regular)}</div></div>`}

function insCards(ins){return ins.map(i=>`<div class="insight-card" onclick="nav('insight',{id:'${i.id}'})">
<div class="im"><span class="badge ${catB(i.category)}">${i.category}</span><span>${i.date}</span><span>${i.read_time_minutes} min read</span></div>
<div class="it">${i.title}</div><div class="is">${i.summary}</div></div>`).join('')}

async function fIns(){const c=$('ic').value;let u='/api/insights';if(c)u+=`?category=${encodeURIComponent(c)}`;delete S.c[u];const d=await F(u);if(d){const regular=d.insights.filter(i=>!i.pinned);$('il').innerHTML=insCards(regular)}}

// ‚îÄ‚îÄ‚îÄ Insight Detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rInsD(el){
const id=S.pr?.id;if(!id){nav('insights');return}
const d=await F(`/api/insights/${id}`);if(!d){el.innerHTML='<p>Not found</p>';return}
const i=d.insight;
el.innerHTML=`<div class="fi"><div class="back" onclick="nav('insights')">‚Üê Back to Insights</div>
<div style="margin-bottom:24px"><div class="im"><span class="badge ${catB(i.category)}">${i.category}</span><span>${i.date}</span><span>${i.read_time_minutes} min read</span><span>By ${i.author}</span></div>
<h1 style="font-family:'DM Sans',sans-serif;font-size:26px;font-weight:700;letter-spacing:-.5px;line-height:1.3;margin-bottom:8px">${i.title}</h1>
<p style="font-size:15px;color:var(--text-s);line-height:1.5">${i.summary}</p></div>
<div class="article">${i.content.split('\n\n').map(p=>{
if(p.startsWith('**')&&p.endsWith('**'))return`<h3>${p.replace(/\*\*/g,'')}</h3>`;
return`<p>${p.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}</p>`}).join('')}</div>
<div style="margin-top:24px;display:flex;gap:8px;flex-wrap:wrap">${i.tags.map(t=>`<span class="badge b-blue">${t}</span>`).join('')}</div></div>`}

// ‚îÄ‚îÄ‚îÄ Messaging Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rMsg(el){
let d;try{const r=await fetch('/api/messages');d=await r.json()}catch(e){el.innerHTML='<p>Failed to load</p>';return}
el.innerHTML=`<div class="fi"><div class="ph1"><h1>Messages</h1><p>Your conversations with the Bridge Research team</p></div>
<div class="card" style="margin-bottom:24px"><div class="card-h"><span class="card-t">New Message</span></div>
<div class="card-b"><div class="msg-form">
<input type="text" id="msgSubj" placeholder="Subject">
<textarea id="msgBody" placeholder="Your message to Bridge Research..."></textarea>
<div style="display:flex;gap:10px;align-items:center"><button class="btn btn-p" onclick="sendMsg()">Send Message</button><span id="msgStatus" style="font-size:12px;color:var(--text-m)"></span></div>
</div></div></div>
<div class="card"><div class="card-h"><span class="card-t">Message History</span><span style="font-size:12px;color:var(--text-m)">${d.count} message${d.count!==1?'s':''}</span></div>
${d.messages.length?d.messages.map(m=>`<div class="msg-item">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<span style="font-size:13px;font-weight:600">${m.subject}</span>
<span style="font-size:11px;color:var(--text-m)">${new Date(m.created_at*1000).toLocaleDateString('en-GB')}</span></div>
<div style="font-size:12.5px;color:var(--text-s);line-height:1.5">${m.body.slice(0,120)}${m.body.length>120?'...':''}</div>
${m.provider_name?`<div style="margin-top:4px"><span class="badge b-blue" style="font-size:10px">${m.provider_name}</span></div>`:''}
<div style="margin-top:6px"><span class="badge ${m.reply?'b-green':'b-amber'}" style="font-size:10px">${m.reply?'Replied':'Awaiting reply'}</span></div>
</div>`).join(''):`<div style="padding:40px;text-align:center;color:var(--text-m);font-size:13px">No messages yet</div>`}
</div></div>`}

async function sendMsg(){
const subj=$('msgSubj').value.trim(),body=$('msgBody').value.trim(),st=$('msgStatus');
if(!subj||!body){st.style.color='var(--red)';st.textContent='Please fill in both fields';return}
st.style.color='var(--text-m)';st.textContent='Sending...';
try{const r=await fetch('/api/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subject:subj,message:body})});
if(r.ok){st.style.color='var(--green)';st.textContent='Message sent';$('msgSubj').value='';$('msgBody').value='';setTimeout(()=>nav('messages'),1000)}
else{const d=await r.json();st.style.color='var(--red)';st.textContent=d.detail||'Failed'}}
catch(e){st.style.color='var(--red)';st.textContent='Failed to send'}}

async function sendAsk(){
const subj=$('askSubj').value.trim(),body=$('askMsg').value.trim(),st=$('askStatus');
if(!subj||!body){st.style.color='var(--red)';st.textContent='Please fill in both fields';return}
const p=S._provData?.provider;
st.style.color='var(--text-m)';st.textContent='Sending...';
try{const r=await fetch('/api/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({subject:subj,message:body,provider_id:p?.id,provider_name:p?.full_name||p?.name})});
if(r.ok){st.style.color='var(--green)';st.textContent='Question sent ‚Äî we\'ll reply within 1 business day';$('askSubj').value='';$('askMsg').value=''}
else{const d=await r.json();st.style.color='var(--red)';st.textContent=d.detail||'Failed'}}
catch(e){st.style.color='var(--red)';st.textContent='Failed to send'}}

// ‚îÄ‚îÄ‚îÄ Account / Preferences Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rAcct(el){
let subs=[];try{const r=await fetch('/api/subscriptions');if(r.ok){const d=await r.json();subs=d.subscriptions}}catch(e){}
let prefs={display:{default_risk_level:7,dark_mode:false},notifications:{frequency:'instant'},subscription_alerts:{}};
try{const r=await fetch('/api/preferences');if(r.ok){const d=await r.json();prefs=d.preferences}}catch(e){}
el.innerHTML=`<div class="fi"><div class="ph1"><h1>Preferences</h1><p>Manage your account settings, display options, notifications and MPS subscriptions</p></div>

<div class="card" style="margin-bottom:24px"><div class="card-h"><span class="card-t">Account Details</span></div>
<div class="card-b" style="padding:0"><table>
<tr><td class="nc" style="width:160px">Name</td><td>${S.user.name}</td></tr>
<tr><td class="nc">Email</td><td>${S.user.email}</td></tr>
<tr><td class="nc">Firm</td><td>${S.user.firm}</td></tr>
<tr><td class="nc">Role</td><td style="text-transform:capitalize">${S.user.role}</td></tr>
</table></div></div>

<div class="card" style="margin-bottom:24px"><div class="card-h"><span class="card-t">Display Preferences</span></div>
<div class="card-b">
<div style="display:flex;flex-direction:column;gap:16px">
<div style="display:flex;align-items:center;justify-content:space-between">
<div><div style="font-size:13.5px;font-weight:500">Default Risk Level</div><div style="font-size:12px;color:var(--text-m)">Pre-select this risk level when viewing provider dashboards</div></div>
<select id="prefRisk" onchange="savePref()" style="min-width:80px">${[3,4,5,6,7,8,9,10].map(r=>`<option value="${r}" ${prefs.display.default_risk_level===r?'selected':''}>${r}</option>`).join('')}</select>
</div>
<div style="display:flex;align-items:center;justify-content:space-between">
<div><div style="font-size:13.5px;font-weight:500">Dark Mode</div><div style="font-size:12px;color:var(--text-m)">Switch to a dark colour scheme</div></div>
<label class="toggle">
<input type="checkbox" id="prefDark" ${prefs.display.dark_mode?'checked':''} onchange="savePref()">
<span class="track"></span>
<span class="knob"></span>
</label>
</div>
</div></div></div>

<div class="card" style="margin-bottom:24px"><div class="card-h"><span class="card-t">Notification Settings</span></div>
<div class="card-b">
<div style="display:flex;align-items:center;justify-content:space-between">
<div><div style="font-size:13.5px;font-weight:500">Email Notification Frequency</div><div style="font-size:12px;color:var(--text-m)">How often you receive email alerts for subscribed MPS updates</div></div>
<select id="prefFreq" onchange="savePref()" style="min-width:120px">
<option value="instant" ${prefs.notifications.frequency==='instant'?'selected':''}>Instant</option>
<option value="daily" ${prefs.notifications.frequency==='daily'?'selected':''}>Daily Digest</option>
<option value="weekly" ${prefs.notifications.frequency==='weekly'?'selected':''}>Weekly Digest</option>
</select>
</div>
</div></div>

<div class="card"><div class="card-h"><span class="card-t">MPS Subscriptions</span><span style="font-size:12px;color:var(--text-m)">${subs.length} active</span></div>
${subs.length?`<div class="card-b" style="padding:0"><table><thead><tr><th>MPS Range</th><th>Subscribed</th><th>Email Alerts</th><th></th></tr></thead>
<tbody>${subs.map(s=>{const alertOn=prefs.subscription_alerts[s.provider_id]!==false;return`<tr><td class="nc" style="cursor:pointer" onclick="nav('provider',{id:'${s.provider_id}'})">${s.provider_name}</td>
<td>${new Date(s.created_at*1000).toLocaleDateString('en-GB')}</td>
<td><label class="toggle toggle-sm toggle-green">
<input type="checkbox" ${alertOn?'checked':''} onchange="togSubAlert('${s.provider_id}',this.checked)">
<span class="track"></span>
<span class="knob"></span>
</label></td>
<td><button class="btn btn-g btn-sm" onclick="unsubProv('${s.provider_id}')">Unsubscribe</button></td></tr>`}).join('')}</tbody></table></div>`
:`<div class="card-b"><p style="color:var(--text-m);font-size:13px">No active subscriptions. Subscribe to MPS ranges from the MPS Analysis dashboards to receive email alerts when data is updated.</p></div>`}
</div></div>`}

async function savePref(){
const body={display:{default_risk_level:parseInt($('prefRisk').value),dark_mode:$('prefDark').checked},notifications:{frequency:$('prefFreq').value}};
try{await fetch('/api/preferences',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})}catch(e){}
savePrefApplyDark(body.display.dark_mode)}

async function togSubAlert(providerId,enabled){
try{await fetch('/api/preferences/subscription-alert',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({provider_id:providerId,enabled})})}catch(e){}}

// ‚îÄ‚îÄ‚îÄ Subscription Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function togSub(providerId,providerName){
const btn=$('subBtn');if(!btn)return;
const isSub=btn.classList.contains('subscribed');
try{if(isSub){const r=await fetch(`/api/subscriptions/${providerId}`,{method:'DELETE'});
if(r.ok){btn.className='sub-btn unsubscribed';btn.innerHTML='üîî Subscribe'}}
else{const r=await fetch('/api/subscriptions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({provider_id:providerId,provider_name:providerName})});
if(r.ok){btn.className='sub-btn subscribed';btn.innerHTML='‚úì Subscribed'}}}catch(e){}}

async function unsubProv(providerId){
try{const r=await fetch(`/api/subscriptions/${providerId}`,{method:'DELETE'});
if(r.ok)nav('account')}catch(e){}}

// Init
checkAuth();
</script>
</body>
</html>
